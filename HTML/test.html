<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <style>
        /* Always set the map height explicitly to define the size of the div
           * element that contains the map. */
        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>

</head>

<body>
    <div id="map"></div>
    <script>
        function initMap() {

            var myLatLng = {
                lat: 24.7571306,
                lng: 120.9522639
            };

            var map = new google.maps.Map(document.getElementById('map'), {
                styles: [{
                        "featureType": "poi.business",
                        "stylers": [{
                            "visibility": "off"
                        }]
                    },
                    {
                        "featureType": "poi.park",
                        "elementType": "labels.text",
                        "stylers": [{
                            "visibility": "off"
                        }]
                    }
                ],
                zoom: 16,
                center: myLatLng
            });
            if (navigator.geolocation) {
                // 使用者不提供權限，或是發生其它錯誤
                function error() {
                    alert('無法取得你的位置');
                }
                // 使用者允許抓目前位置，回傳經緯度
                function success(position) {
                    console.log(position.coords.latitude, position.coords.longitude);
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    var marker = new google.maps.Marker({
                        position: pos,
                        label: "我的位置",
                        map: map
                    });
                }
                // 跟使用者拿所在位置的權限
                navigator.geolocation.getCurrentPosition(success, error);

            } else {
                alert('Sorry, 你的裝置不支援地理位置功能。')
            }
            var geometry = []
            var properties = []
            var total = []
            var storeaddress = []
            window.onload = function () {
                let xhr = new XMLHttpRequest;
                xhr.onload = function () {
                    _data = JSON.parse(this.responseText).features;
                    console.log(_data)
                    _data.forEach((item, index) => {
                        let geo = item.geometry
                        // console.log(geo)
                        let pro = item.properties
                        geometry.push({
                            geo
                        })
                        properties.push({
                            pro
                        })
                    });
                    for (let i = 0; i < properties.length; i++) {
                        let g = geometry[i]
                        for (let item in g) {
                            // console.log(g[item].coordinates)
                            storeaddress.push(g[item].coordinates)
                        }
                        let p = properties[i]
                        total.push({
                            storeaddress: storeaddress[i],
                            mask: properties[i].pro
                        })
                    }
                    // console.log(total[0].mask.name)
                    // console.log(total.length)
                    let longitude = [];
                    let latitude = [];
                    for (let i = 0; i < total.length; i++) {
                        // console.log(typeof (total[i].mask.mask_adult))
                        longitude[i] = total[i].storeaddress[1];
                        latitude[i] = total[i].storeaddress[0];
                        let havenot = total[i].mask.mask_adult
                        let markers = new google.maps.Marker({
                            position: {
                                lat: longitude[i],
                                lng: latitude[i]
                            },
                            map: map,
                            title: `${total[i].mask.name}`,
                            icon: ''
                        })
                        if (havenot == 0) {
                            markers.icon = {
                                url: "masknn.png",
                                scaledSize: new google.maps.Size(40, 40)
                            }

                        } else {
                            markers.icon = {
                                url: "mask.png",
                                scaledSize: new google.maps.Size(40, 40)
                            }
                        }
                        let a = -1;
                        let contentString = 
                        '<div>'+
                        '<h4>' + total[i].mask.name + '</h4>'
                        +'<p> 電話 : '+total[i].mask.phone+'</p>'
                        +'<p> 地址 : '+total[i].mask.address+'</p>'
                        +'<p> 成人口罩數量 : '+total[i].mask.mask_adult+'</p>'
                        +'<p> 兒童口罩數量 : '+total[i].mask.mask_child+'</p>'
                        +'<p>'+total[i].mask.custom_note+'</p>'+'</div>'
                        markers.addListener('click', function () {
                                var infowindow = new google.maps.InfoWindow({
                                    content: contentString,
                                    position: {
                                        lat: longitude[i],
                                        lng: latitude[i]
                                    },
                                    maxWidth:250
                                });
                                infowindow.open(map, markers);
                        });
                    }

                }
                xhr.open("GET",
                    "https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json");
                xhr.send();
            }

        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAlKWP4uWjQIR3WDAWLAu6rUhBfc3_ppag &callback=initMap"
        async defer></script>

</body>

</html>