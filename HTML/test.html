<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <style>
        /* Always set the map height explicitly to define the size of the div
           * element that contains the map. */
        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
         button{
            width: 20%;
        }
        .countrybutton button{
            background-color: #333;
            color: #fff;
        }
        .townbutton button{
            background-color: #333;
            color: #fff;
        }
    </style>

</head>

<body>
    <div class="countrybutton">
        <!-- <div class="townbutton"></div> -->
    </div>
    <div class="townbutton"></div>

    <div id="map"></div>
    <script>
        function initMap() {

            var myLatLng = {
                lat: 24.7571306,
                lng: 120.9522639
            };

            var map = new google.maps.Map(document.getElementById('map'), {
                styles: [{
                        "featureType": "poi.business",
                        "stylers": [{
                            "visibility": "off"
                        }]
                    },
                    {
                        "featureType": "poi.park",
                        "elementType": "labels.text",
                        "stylers": [{
                            "visibility": "off"
                        }]
                    }
                ],
                zoom: 15,
                center: myLatLng
            });

            if (navigator.geolocation) {
                // 使用者不提供權限，或是發生其它錯誤
                function error() {
                    alert('無法取得你的位置');
                }
                // 使用者允許抓目前位置，回傳經緯度
                function success(position) {
                    // console.log(position.coords.latitude, position.coords.longitude);
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(pos);
                    var marker = new google.maps.Marker({
                        position: pos,
                        label: "我的位置",
                        map: map
                    });
                }
                // 跟使用者拿所在位置的權限
                navigator.geolocation.getCurrentPosition(success, error);

            } else {
                alert('Sorry, 你的裝置不支援地理位置功能。')
            }

            var geometry = []
            var properties = []
            var total = []
            var storeaddress = []
            var country11 = []
            var country22 = []
            var country = []

            window.onload = function () {
                let xhr = new XMLHttpRequest;
                xhr.onload = function () {
                    _data = JSON.parse(this.responseText).features;
                    // console.log(_data)

                    _data.forEach((item, index) => {
                        let geo = item.geometry
                        // console.log(geo)
                        let pro = item.properties
                        geometry.push({
                            geo
                        })
                        properties.push({
                            pro
                        })
                    });
                    for (let i = 0; i < properties.length; i++) {
                        let g = geometry[i]
                        for (let item in g) {
                            // console.log(g[item].coordinates)
                            storeaddress.push(g[item].coordinates)
                        }
                        let p = properties[i]
                        total.push({
                            storeaddress: storeaddress[i],
                            mask: properties[i].pro
                        })
                    }
                    // console.log(total[0].mask.name)
                    // console.log(total.length)
                    let longitude = [];
                    let latitude = [];
                    for (let i = 0; i < total.length; i++) {
                        // console.log(typeof (total[i].mask.mask_adult))
                        latitude[i] = total[i].storeaddress[1];
                        longitude[i] = total[i].storeaddress[0];
                        let havenot = total[i].mask.mask_adult
                        let markers = new google.maps.Marker({
                            position: {
                                lat: latitude[i],
                                lng: longitude[i]
                            },
                            map: map,
                            title: `${total[i].mask.name}`,
                            icon: ''
                        })
                        if (havenot == 0) {
                            markers.icon = {
                                url: "masknn.png",
                                scaledSize: new google.maps.Size(40, 40)
                            }

                        } else {
                            markers.icon = {
                                url: "mask.png",
                                scaledSize: new google.maps.Size(40, 40)
                            }
                        }
                        var haveinfo = '';
                        let contentString =
                            '<div>' +
                            '<h4>' + total[i].mask.name + '</h4>' +
                            '<p> 電話 : ' + total[i].mask.phone + '</p>' +
                            '<p> 地址 : ' + total[i].mask.address + '</p>' +
                            '<p> 成人口罩數量 : ' + total[i].mask.mask_adult + '</p>' +
                            '<p> 兒童口罩數量 : ' + total[i].mask.mask_child + '</p>' +
                            '<p>' + total[i].mask.custom_note + '</p>' + '</div>';

                        markers.addListener('click', function () {
                            if (haveinfo != '') {
                                haveinfo.close();
                                haveinfo = '';
                            }
                            var infowindow = new google.maps.InfoWindow({
                                content: contentString,
                                position: {
                                    lat: longitude[i],
                                    lng: latitude[i]
                                },
                                maxWidth: 250
                            });
                            infowindow.open(map, markers);
                            haveinfo = infowindow;
                        });
                    }
                    for (let i = 0; i < total.length; i++) {
                        country.push({
                            Country: total[i].mask.county,
                            Town: total[i].mask.town,
                            Storeaddress: total[i].storeaddress
                        })
                    }
                    // console.log(country)
                    const set1 = new Set();
                    const country1 = country.filter(item => !set1.has(item.Country) ? set1.add(item.Country) :
                        false);
                    country1.forEach((item, index) => {
                        if (item.Country !== "") {
                            country11.push(item)
                        }
                    })
                    add()
                    var btn = document.getElementsByTagName("button")
                    for (let item of btn) {
                        // console.log(item)
                        item.onclick = function () {
                            _thsort(item);
                        }
                    }
                    // var townbtn = document.getElementsByClassName("townbtn")
                    // console.log(townbtn)
                    // for (let item of townbtn) {
                    //     console.log(item)
                    //     item.onclick = function () {
                    //         _townmap(item);
                    //     }
                    // }
                }
                xhr.open("GET",
                    "https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json");
                xhr.send();
            }

            // console.log(total)
            function _thsort(btn) {

                var btn = btn.id;
                var btncountry = []
                var towndiv = document.getElementsByTagName('div')[1];
                towndiv.innerHTML = ""
                // console.log(btn)
                for (let i = 0; i < country.length; i++) {
                    if (country[i].Country == btn) {
                        btncountry.push({
                            Country: country[i].Country,
                            Town: country[i].Town,
                            Storeaddress: country[i].Storeaddress
                        })
                    }
                }
                // console.log(btncountry)
                const set2 = new Set();
                const country2 = btncountry.filter(item => !(set2.has(item.Town)) ? set2.add(item.Town) :
                    false);
                console.log(country2);
                country2.forEach((item, index) => {
                    if (item.Country !== "") {
                        country22.push(item)
                    }
                })
                console.log(country22) //地區

                for (let i = 0; i < country22.length; i++) {
                    if (country22[i].Country == btn) {
                        var townbtn = document.createElement('button')
                        townbtn.innerHTML = country22[i].Town
                        towndiv.appendChild(townbtn)
                        townbtn.setAttribute('id', country22[i].Town)
                        townbtn.setAttribute('class', "townbtn")
                    }
                }
                var townbtn = document.getElementsByClassName("townbtn")
                console.log(townbtn)
                for (let item of townbtn) {
                    console.log(item)
                    item.onclick = function () {
                        _townmap(item);
                    }
                }

            }

            function _townmap(tbtn) {
                var tbtn = tbtn.id
                for (let i = 0; i < country22.length; i++) {
                    if (country22[i].Town == tbtn) {
                        // console.log(country22[i].Storeaddress[1])
                        var tpos = {
                            lat: country22[i].Storeaddress[1],
                            lng: country22[i].Storeaddress[0]
                        };
                        map.setCenter(tpos);

                    }
                }
            }


            function add() {
                // console.log(country11); //縣市
                // console.log(country11.length); //縣市
                // console.log(country11[1].Country); //縣市
                var addcountry = document.getElementsByTagName('div')[0]
                for (let i = 0; i < country11.length; i++) {
                    let cbutton = document.createElement('button')
                    cbutton.innerHTML = country11[i].Country;
                    addcountry.appendChild(cbutton);
                    cbutton.setAttribute('id', country11[i].Country)
                }

            }

        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAlKWP4uWjQIR3WDAWLAu6rUhBfc3_ppag &callback=initMap"
        async defer></script>

</body>

</html>