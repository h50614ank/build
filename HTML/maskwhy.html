<!DOCTYPE html>
<html>

<head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

    <style>
        /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        var map;
        var maskPosJson;
        var displayCountry = [];
        var countries = [];
        var closeCountryFlag = true;
        var aliveInfoWindow = '';

        MapAndDataInit();

        function MapAndDataInit() {

            // let url = "NewMaskData.json";
            let url = "https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json";
            let xhr = new XMLHttpRequest;
            xhr.onload = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    maskPosJson = JSON.parse(this.responseText).features;
                    dataFeed_callback(maskPosJson);
                } else {
                    console.log('load error');
                }
            }
            xhr.open("GET", url);
            xhr.send();
        };

        function dataFeed_callback(positionInfoData) {
            positionInfoData.forEach(everyPos => {
                let latLng = new google.maps.LatLng(everyPos.geometry.coordinates[1], everyPos.geometry.coordinates[0]);

                let iconAvalibel = 'http://maps.google.com/mapfiles/kml/paddle/grn-stars.png';
                let iconNoStock = 'http://maps.google.com/mapfiles/kml/paddle/red-square.png';

                let marker = new google.maps.Marker({
                    position: latLng,
                    icon: '',
                    map: map
                });
                if (everyPos.properties.mask_adult === 0) {
                    marker.icon = iconNoStock;
                } else {
                    marker.icon = iconAvalibel;
                }

                let contentString =
                    '<div>' +
                    '<h5>店家名稱 : ' + everyPos.properties.name + '</h5>' +
                    '<p>地址 : ' + everyPos.properties.address + '</p>' +
                    '<p>電話 : ' + everyPos.properties.phone + '</p>' +
                    '<p>成人口罩數量 : ' + everyPos.properties.mask_adult + '</p>' +
                    '<p>兒童口罩數量 : ' + everyPos.properties.mask_child + '</p>';

                contentString += GetAvalibleTable(everyPos.properties.available);

                contentString +=
                    '<p>備註 : ' + everyPos.properties.note + '</p>' +
                    '<p>最後更新時間 : ' + everyPos.properties.updated + '</p>' +
                    '</div>';
                var infowindow = new google.maps.InfoWindow({
                    content: contentString
                });
                marker.addListener('click', function () {
                    if (aliveInfoWindow != '') {
                        aliveInfoWindow.close();
                        aliveInfoWindow = '';
                    }
                    var infoWindow = new google.maps.InfoWindow({ content: contentString });
                    infowindow.open(map, marker);
                    aliveInfoWindow = infowindow;
                });


                CollectCountries(everyPos.properties);
            });
        };

        function GetAvalibleTable(rowText) {
            let resultTable = '';
            let startText = '<table><tbody><tr><th>星期一</th><th>星期二</th><th>星期三</th><th>星期四</th><th>星期五</th><th>星期六</th><th>星期日</th></tr>';
            let endText = '<tbody><table>';

            let availableTextArr = rowText.split('、').map(x => x.substring(5));

            resultTable += startText;
            for (let trIndex = 0; trIndex < 3; trIndex++) {
                resultTable += '<tr>';
                for (let tdIndex = 0; tdIndex < 7; tdIndex++) {
                    resultTable += '<td>';
                    if (availableTextArr[trIndex * tdIndex] == undefined || availableTextArr[trIndex * tdIndex] =='') {
                        resultTable += ' - ';
                    }else{
                        resultTable += availableTextArr[trIndex * tdIndex];
                    };
                    resultTable += '</td>';
                };
                resultTable += '</tr>';
            };
            resultTable += endText;

            return resultTable;
        };

        function CollectCountries(inputCountry) {
            let inputCountryName = inputCountry.county;
            let countryIndex = displayCountry.indexOf(inputCountryName);
            if (countryIndex == -1 && inputCountryName != '') {
                displayCountry.push(inputCountryName);

                countries.push({ countryName: inputCountryName, towns: [] });

                let newLi = document.createElement('li');
                newLi.textContent = inputCountryName;
                newLi.className = 'list-group-item';
                newLi.addEventListener('click', EventClickExpandCountry);
                document.getElementById('countryList').appendChild(newLi);
            };

            if (countryIndex != -1) {
                if (countries[countryIndex].towns.indexOf(inputCountry.town) == -1) {
                    countries[countryIndex].towns.push(inputCountry.town);
                }
            }
        };

        function EventClickExpandCountry() {
            let countryIndex = displayCountry.indexOf(this.innerText);
            ClearExistTown(this);
            ImportTowns(this, countryIndex);
            let test = document.createElement('li');
            this.removeEventListener('click', EventClickExpandCountry);
        };

        function ImportTowns(countryNode, countryIndex) {
            countries[countryIndex].towns.forEach(eachTown => {
                let liTown = document.createElement('li');
                liTown.innerText = eachTown;
                liTown.className = 'list-group-item list-town';
                liTown.addEventListener('click', EventClickTown);
                countryNode.insertBefore(liTown, null);
            });
            countryNode.addEventListener('click', EventCloseCurrent);
        };

        function EventCloseCurrent() {
            if (closeCountryFlag) {
                ClearExistTown(this);
            } else {
                closeCountryFlag = true;
            }
        }

        function EventClickTown() {
            closeCountryFlag = false;
            for (let index = 0; index < maskPosJson.length; index++) {
                const element = maskPosJson[index];
                if (maskPosJson[index].properties.town == this.innerText &&
                    maskPosJson[index].properties.county == this.parentNode.childNodes[0].data) {
                    let lat = maskPosJson[index].geometry.coordinates[1];
                    let lng = maskPosJson[index].geometry.coordinates[0];
                    map.setCenter({
                        lat: lat,
                        lng: lng
                    });
                    break;
                }
            }
        }

        function ClearExistTown(imputCountryNode) {
            let countryNodes = imputCountryNode.parentNode.querySelectorAll('.list-town');
            if (countryNodes.length != 0) {
                countryNodes[0].parentNode.addEventListener('click', EventClickExpandCountry);
            }
            countryNodes.forEach(eachNode => {
                eachNode.remove();
            })
        };

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 25.0443278, lng: 121.5416321 },
                zoom: 15
            });
            infoWindow = new google.maps.InfoWindow;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    // alert(pos.lat + ' ' + pos.lng);
                    // infoWindow.setPosition(pos);
                    // infoWindow.setContent('Location found.');
                    // infoWindow.open(map);
                    map.setCenter(pos);
                }, function () {
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                handleLocationError(false, infoWindow, map.getCenter());
            }
        };

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAlKWP4uWjQIR3WDAWLAu6rUhBfc3_ppag &callback=initMap"
        async defer></script>
</body>

</html>